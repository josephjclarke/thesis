\chapter{The Compost Bomb and the Terrestrial Carbon Cycle}
\graphicspath{{global_bomb/figs/}}

\todo[inline]{This is basically just going to be equations for now}

Following\cite{Luke2011}, we have the compost comb equations
\begin{subequations}
  \label{eq:compost_bomb_equations}
  \begin{align}
    \mu \dv{T_s}{t} &= - \kappa \left(T_s - T_a\right) + Ar_0C_se^{\alpha T_s} \label{eq:compost_bomb_soil_temperature} \\
    \dv{C_s}{t} &= \Pi - r_0C_se^{\alpha T_s} \label{eq:compost_bomb_soil_carbon}
  \end{align}
\end{subequations}

Noting the obvious timescale seperation in \cref{eq:compost_bomb_equations} we can put \cref{eq:compost_bomb_soil_temperature} into
equilibrium to get
\begin{equation*}
  0 = - \kappa \left(T_s - T_a\right) + Ar_0C_se^{\alpha T_s}
\end{equation*}
which can be solved for the soil temperature to  give
\begin{equation}
  \label{eq:soil_temperature_equilibrium}
  T_s = T_a - \frac{1}{\alpha} W\left(-\frac{Ar_0C_s \alpha e^{\alpha T_a}}{\kappa} \right),
\end{equation}
where $W(x)$ is the Lambert $W$ function. The Lambert $W$ function is defined as the solution to the equation
\begin{equation}
  \label{eq:lambert_W}
  W(x)e^{W(x)} = x.
\end{equation}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \begin{axis}[
      xmin=-1,
      xmax=4,
      enlarge y limits=false,
      axis lines=left,
      xlabel=$x$,
      ylabel=$W(x)$,
      samples=50]
      \addplot[domain=-5:-1] (x * exp(x), x);
      \addplot[domain=-1:2] (x * exp(x), x);
    \end{axis}
  \end{tikzpicture}
  \caption{The Lambert $W$ function}
  \label{fig:lambert_W}
\end{figure}
The Lambert $W$ is plotted in \cref{fig:lambert_W}.

Defining
\begin{equation}
  \label{eq:critical_npp}
  \Pi_c = \frac{\kappa}{\alpha A}
\end{equation}
we can rewrite \cref{eq:soil_temperature_equilibrium} as
\begin{equation}
  \label{eq:soil_temperature_equilibrium_nppc}
  T_s = T_a - \frac{1}{\alpha} W\left(-\frac{r_0C_s e^{\alpha T_a}}{\Pi_c} \right).
\end{equation}
We should therefore insert \cref{eq:soil_temperature_equilibrium_nppc} in \cref{eq:compost_bomb_soil_carbon}
to give
\begin{equation}
  \label{eq:soil_carbon_evolution}
  \dv{C_s}{t} = \Pi + \Pi_c W\left(-\frac{r_0C_s e^{\alpha T_a}}{\Pi_c} \right).
\end{equation}
This implies the equilibrium value of $C_s$ is
\begin{equation}
  \label{eq:equilibirum_soil_carbon}
  C_s^{\mathrm{eq}} = \frac{\Pi}{r_0} e^{-\alpha T_a} e^{-\Pi/\Pi_c}.
\end{equation}
Note that we recover the no biogeochemcial heating case by sending $\Pi_c \rightarrow \infty$.


Recognising that
\begin{equation}
  \label{eq:atmospheric_temperatures}
  T_a = \frac{S}{\log 2} \log \frac{C_a}{C_{a0}} 
\end{equation}
leads, upon substituting \cref{eq:atmospheric_temperatures} into \cref{eq:soil_carbon_evolution},
\begin{equation}
  \label{eq:global_soil_carbon}
  \dv{C_s}{t} = \Pi + \Pi_c W\left(-\frac{r_0C_s}{\Pi_c} \left(\frac{C_a}{C_{a0}}\right)^\mu \right),
\end{equation}
where
\begin{equation}
  \label{eq:mu}
  \mu = \frac{\alpha S}{\log 2}.
\end{equation}


We chose the temperature anomaly so that $T_a = 0$ corresponds to an equilibrium. We can then set
$r_0 = \frac{\Pi_0}{C_s^{\mathrm{eq}}}e^{-\Pi_0/\Pi_c}$, where $\Pi_0 = \Pi\left(C_{a0}\right)$.

To find the bifurcation we therefore just have to calculate where
\begin{equation*}
  \dv{\dot{C_s}}{C_s} = 0,
\end{equation*}
we will make use of
\begin{equation}
  \label{eq:derivative_of_lambert_W}
  W'(x) = \frac{W(x)}{x\left(1 + W\left(x\right)\right)}.
\end{equation}




Taking a derivative of the right hand side of \cref{eq:global_soil_carbon} and setting it to zero in equilibrium gives
\begin{equation}
  \label{eq:soil_carbon_lambda}
  \dv{\Pi}{C_a}\dv{C_a}{C_s} + \frac{\Pi_c}{C_s^{\mathrm{eq}}} \frac{W\left(-\frac{r_0C_s^{\mathrm{eq}}}{\Pi_c}\right)}{1+W\left(-\frac{r_0C_s^{\mathrm{eq}}}{\Pi_c}\right)} \left(
    1 + \mu \frac{C_s^{\mathrm{eq}}}{C_{a0}} \dv{C_a}{C_s}\right) = 0
\end{equation}
so
\begin{equation}
  \label{eq:critical_mu}
  \mu = -\frac{C_{a0}}{C_{s}^{\mathrm{eq}}}\dv{C_s}{C_a}\left(\dv{\Pi}{C_a}\dv{C_a}{C_s} \frac{C_s^{\mathrm{eq}}}{\Pi_c}\frac{1+W\left(-\frac{r_0C_s^{\mathrm{eq}}}{\Pi_c}\right)}{W\left(-\frac{r_0C_s^{\mathrm{eq}}}{\Pi_c}\right)} + 1 \right)
\end{equation}

We will assume  that a fixed fraction $\chi_0$ of atmospheric emissions reaches the ocean, meaning
\begin{equation}
  \label{eq:simple_ocean}
  C_a = C_{a0} -\frac{1}{1+\chi_0} (C_s - C_{s}^{\mathrm{eq}})
  %C_s = C_{s}^{\mathrm{eq}} - (1 + \chi_0)(C_a - C_{a0}.
\end{equation}
gives
\begin{equation}
  \label{eq:critical_mu_simple_ocean}
  \mu = \left(1+\chi_0\right) \frac{C_{a0}}{C_{s}^{\mathrm{eq}}} -
  \frac{C_{a0}}{\Pi_c}\frac{1+W\left(-\frac{r_0C_s^{\mathrm{eq}}}{\Pi_c}\right)}{W\left(-\frac{r_0C_s^{\mathrm{eq}}}{\Pi_c}\right)}\dv{\Pi}{C_a}
\end{equation}
or
\begin{equation*}
  \mu = \left(1+\chi_0\right) \frac{C_{a0}}{C_{s}^{\mathrm{eq}}} -
  \frac{C_{a0}}{\Pi_c}
  \frac{1+W\left(-\frac{\Pi_0}{\Pi_c}\exp\left(-\frac{\Pi_0}{\Pi_c}\right)\right)}
  {W\left(-\frac{\Pi_0}{\Pi_c}\exp\left(-\frac{\Pi_0}{\Pi_c}\right)\right)}\dv{\Pi}{C_a} 
\end{equation*}
or
\begin{equation*}
  \mu = \left(1+\chi_0\right) \frac{C_{a0}}{C_{s}^{\mathrm{eq}}} -
  \frac{C_{a0}}{\Pi_c}
  \frac{1-\frac{\Pi_0}{\Pi_c}\exp\left(-\frac{\Pi_0}{\Pi_c}\right)}{-\frac{\Pi_0}{\Pi_c}\exp\left(-\frac{\Pi_0}{\Pi_c}\right)}\dv{\Pi}{C_a} .
\end{equation*}
Cleaning this up gives
\begin{equation}
  \label{eq:critical_mu_simple_ocean_in_terms_of_npp}
  \mu^* = \left(1+\chi_0\right) \frac{C_{a0}}{C_{s}^{\mathrm{eq}}} +
  \frac{C_{a0}}{\Pi_0}\exp\left(\frac{\Pi_0}{\Pi_c}\right)  \dv{\Pi}{C_a} - \frac{C_{a0}}{\Pi_c} \dv{\Pi}{C_a}
\end{equation}

Taking the limit where $\Pi_c \rightarrow \infty$ gives
\begin{equation}
  \label{eq:mu_infinity}
  \mu^*_{\infty} = \left(1+\chi_0\right) \frac{C_{a0}}{C_{s}^{\mathrm{eq}}} +
  \frac{C_{a0}}{\Pi_0}  \dv{\Pi}{C_a}
\end{equation}

We note this implies a minimum allowed \ce{CO2} fertilization effect for a given $\mu$ (as we need $\mu < \mu_\infty^*$)
\begin{equation}
  \label{eq:minimum_allowed_co2_fertilization}
  \dv{\Pi}{C_a} > \frac{\Pi_0\mu}{C_{a0}} - \frac{1+\chi_0}{C_s^{\mathrm{eq}}}
\end{equation}


We can plot \cref{eq:critical_mu} to devide the parameter plane into a stable and unstable region.

\begin{figure}
  \centering
  \begin{tikzpicture}[
    /pgf/declare function={
      chi0 = 0.25;
      npp = 55.0;
      Ca0 = 589.0;
      Cseq = 1500.0;
    }
    ]
    \begin{axis}[
      legend pos=outer north east,
      % enlargelimits=false
      xlabel={$\Pi_c$},
      ylabel={$\mu^*$}
      ]
      \addplot[
      domain=100:2000,
      samples=100,
      enlarge x limits=false,
      color=red]
      {(1+chi0)*Ca0/Cseq + 0.03 * ((Ca0/npp) * exp(npp/x)  - (Ca0/x))};
      \addlegendentry{$\dv*{\Pi}{C_a} = 0.03$}
    \end{axis}
 
    
  \end{tikzpicture}
  \caption{The parameter plane}
  \label{fig:critical_mu_vs_pic}
\end{figure}\todo{This is wrong}


\begin{figure}
  \centering
  \begin{tikzpicture}[
    /pgf/declare function={
      chi0 = 0.25;
      npp = 55.0;
      Ca0 = 589.0;
      Cseq = 1500.0;
    }
    ]
    \begin{axis}[
      xlabel = $\mu$,
      ylabel = $\dv{\Pi}{C_a}$ \unit{\per\year},
      xmin=0.0,
      xmax=1.0
      ]
      \addplot[domain=0:1.0] {npp * x / Ca0 - (1+chi0) / Cseq};
    \end{axis}
    \end{tikzpicture}
  \caption{Minimum \ce{CO2} fertilization strength}
  \label{fig:minimum_co2_fertilization}
\end{figure}

% We will assume
% \begin{equation}
%   \label{eq:npp_fertilization}
%   \Pi(C_a) = \Pi_{\infty}\frac{C_a}{C_a + C_{a_{1/2}}}.
% \end{equation}